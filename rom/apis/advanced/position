-- Position of Computer Relative to Coordinate System

-- Purpose:
--   Different coordinate systems
--     global = equal to minecraft coordinates
--     regional = valid for a region, specifically set up by user
--     local = local to computer starting at 0, 0, 0 (useful for turtles)
--   Upgrade of coordinate data to best available coordinate system

-- Todo:
--   coordinate system abstraction with conversion from one to other
--   regional coordinates
--   abstraction of direction
--   interface for position changes (turtle)

local persist = loader.requireApi("persistency")
local tx = loader.requireApi("transformation")

-- Position Logic ---------------------------------------------------------

--local myID = os.getComputerID()
local initialLocation = {pos=tx.identity, moving=false}
local location = persist.new("position", initialLocation)
location.value.pos = tx.newFromTable(location.value.pos)
if location.value.moving then
  print("Position was changing during shutdown, resetting.")
  location.value = initialLocation
  -- reset other ???
end
location:store()

-- Movement -----------------------------------------------------------

local moveTx = nil

function startMoving(transformation)
  location.value.moving = true
  location:store()
  moveTx = transformation
end

function stopMoving(success)
  location.value.moving = false
  if success then
    location.value.pos = location.value.pos:concat(moveTx)
    moveTx = nil
  end
  location:store()
end

__lunit = {}

local function check(x, y, z, t)
  local pos=location.value.pos
  --pos.offset
end

function __lunit.path()
  location.value = initialLocation
  local fw = tx.move(vector.new(1, 0, 0))
  startMoving(fw)
  stopMoving(false)
  startMoving(fw)
  stopMoving(true)
  lunit.areEqual(fw, location.value.pos)
  startMoving(tx.turn(1))
  stopMoving(true)
  startMoving(fw)
  stopMoving(true)
  lunit.areEqual(vector.new(1, 0, -1), location.value.pos:apply(vector.new(0, 0, 0)))
  lunit.areEqual(vector.new(1, 0, -2), location.value.pos:apply(vector.new(1, 0, 0)))
end
